name: Merge to Main

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  terraform-checks:
    name: Terraform Validate & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v4

      # TODO: Set up Terraform 
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      # TODO: Run terraform fmt -check
      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      # TODO: Run terraform init -backend=false
      - name: Terraform Init
        run: terraform init -backend=false

      # TODO: Run terraform validate
      - name: Terraform Validate
        run: terraform validate

      # TODO: Install and run tflint
      - name: Install TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Init TFLint
        run: tflint --init
  
      - name: Run TFLint
        run: tflint --recursive

      # TODO: Run checkov or tfsec against the terraform directory
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform
          framework: terraform
          soft_fail: false
          skip_check: CKV_AWS_91,CKV_AWS_260,CKV_AWS_130,CKV2_AWS_30,CKV2_AWS_57,CKV2_AWS_12,CKV2_AWS_28

  docker-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # TODO: Run hadolint on app/Dockerfile
      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: app/Dockerfile

  docker-build-and-scan:
    name: Docker Build & Trivy Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # TODO: Build the Docker image from app/Dockerfile

      - name: Build Docker image
        run: docker build -t app:${{ github.sha }} ./app

      # TODO: Run Trivy vulnerability scanner on the built image

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: "app:${{ github.sha }}"
          format: "table"
          exit-code: "0"
          severity: "CRITICAL,HIGH"


  app-security:
    name: Application Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # TODO: Run npm audit or trivy fs on the app directory

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        working-directory: app
        run: npm ci
        
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: "fs"
          scan-ref: "./app"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # TODO: Run gitleaks to detect any hardcoded secrets
      
      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker-compose-test:
    name: Docker Compose Integration Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # TODO: Start services with docker compose up -d
      - name: Start services
        run: docker compose up -d --build

      # TODO: Wait for services to be healthy
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to become healthy..."
          for i in $(seq 1 30); do
            if curl -s http://localhost:3000/api/db-check | grep -q '"success":true'; then
              echo "Services are healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - waiting 5s..."
            sleep 5
          done
          echo "Services failed to become healthy"
          docker compose logs
          exit 1

      # TODO: Curl localhost:3000/api/db-check and verify a successful response

      - name: Verify db-check response
        run: |
          RESPONSE=$(curl -s http://localhost:3000/api/db-check)
          echo "Response: $RESPONSE"
          echo "$RESPONSE" | grep -q '"success":true' || (echo "db-check failed" && exit 1)

      # TODO: Tear down with docker compose down

      - name: Tear down services
        if: always()
        run: docker compose down -v


  build-and-push:
    name: Build & Push to GHCR
    runs-on: ubuntu-latest
    needs:
      - terraform-checks
      - docker-lint
      - docker-build-and-scan
      - app-security
      - secret-detection
      - docker-compose-test
    steps:
      - uses: actions/checkout@v4

      # TODO: Log in to GHCR
      # Hint: use docker/login-action with registry ghcr.io
      #       username: ${{ github.actor }}
      #       password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # TODO: Build the Docker image

      - name: Build Docker image
        run: docker build -t ghcr.io/${{ github.repository }}:${{ github.sha }} ./app

      # TODO: Tag the image with the Git SHA and "latest"
      # Hint: ghcr.io/${{ github.repository }}:${{ github.sha }}
      #       ghcr.io/${{ github.repository }}:latest

      - name: Tag image as latest
        run: docker tag ghcr.io/${{ github.repository }}:${{ github.sha }} ghcr.io/${{ github.repository }}:latest

      - name: Push SHA-tagged image
        run: docker push ghcr.io/${{ github.repository }}:${{ github.sha }}


      # TODO: Push both tags to GHCR
      - name: Push latest-tagged image
        run: docker push ghcr.io/${{ github.repository }}:latest

